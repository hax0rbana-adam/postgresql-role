# file: postgresql/tasks/install_apt.yml
# Purpose: Install PostgreSQL from PGDG on Debian/Ubuntu in a future-proof way
# Notes:
# - No use of deprecated top-level facts (uses ansible_facts[...] instead)
# - No use of deprecated apt_key (uses a keyring + signed-by)
# - Uses HTTPS and proper keyring location to satisfy apt-secure
# - Adds default_release only when PGDG suite is available

# --- Pre-reqs for HTTPS and key handling ---
# We need CA certs, curl and gnupg to fetch and dearmor the repo key.
- name: Ensure APT HTTPS/key prerequisites are present
  ansible.builtin.apt:
    name:
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
    state: present
    update_cache: true
  when: ansible_facts['pkg_mgr'] == 'apt'

- name: PostgreSQL | Add PostgreSQL repository (deb822)
  ansible.builtin.deb822_repository:
    name: postgresql
    types: ["deb"]
    uris: ["{{ postgresql_apt_repository_url }}"]
    suites: ["{{ ansible_distribution_release }}-pgdg"]
    components: ["main", "{{ postgresql_version }}"]
    signed_by: "{{ postgresql_apt_key_url }}"
    state: present
  when:
    - postgresql_install_repository
    - ansible_facts.packages.apt is defined
    - ansible_facts.packages.apt[0].version is version('2.4', '>=')

- name: PostgreSQL | Add PostgreSQL repository apt-key | apt
  apt_key:
    id: "{{ postgresql_apt_key_id }}"
    url: "{{ postgresql_apt_key_url }}"
    state: present
    keyring: /etc/apt/trusted.gpg.d/postgresql.gpg
  when:
    - postgresql_apt_key_url is defined and postgresql_apt_key_url | length > 0
    - postgresql_apt_key_id is defined and postgresql_apt_key_id | length > 0
    - postgresql_install_repository
    - ansible_facts.packages.apt[0].version is version('2.4', '<')

- name: PostgreSQL | Add PostgreSQL repository | apt
  apt_repository:
    repo: "{{ postgresql_apt_repository }}"
    state: present
  when:
   - postgresql_apt_repository | default('') != ''
   - postgresql_install_repository
   - ansible_facts.packages.apt[0].version is version('2.4', '<')

- name: PostgreSQL | Add PostgreSQL repository preferences | apt
  template:
    src: etc_apt_preferences.d_apt_postgresql_org_pub_repos_apt.pref.j2
    dest: /etc/apt/preferences.d/apt_postgresql_org_pub_repos_apt.pref
  when:
    # cast to int, compare => boolean
    - (postgresql_apt_pin_priority | default(0) | int) > 0
    - (postgresql_install_repository | default(true)) | bool

# --- Ensure role-level APT dependencies are present ---
# This is where you can ensure build or runtime deps required before installing PostgreSQL.
- name: Ensure role APT dependencies are installed
  ansible.builtin.apt:
    name: "{{ postgresql_apt_dependencies | default([]) }}"
    state: present
    update_cache: true
    cache_valid_time: "{{ apt_cache_valid_time | default(3600) }}"
  when:
    - ansible_facts['pkg_mgr'] == 'apt'
    - (postgresql_apt_dependencies | default([])) | length > 0

# --- Install PostgreSQL packages from PGDG ---
# Use default_release only if we know the suite; this avoids "invalid APT::Default-Release" errors.
- name: Install PostgreSQL server/client/contrib
  ansible.builtin.apt:
    name:
      - "postgresql-{{ postgresql_version }}"
      - "postgresql-client-{{ postgresql_version }}"
      - "postgresql-contrib-{{ postgresql_version }}"
    state: present
    update_cache: true
    cache_valid_time: "{{ apt_cache_valid_time | default(3600) }}"
    default_release: >-
      {{ postgresql_default_release
         | default(postgresql_apt_suite | default(omit)) }}
  environment: "{{ postgresql_env | default({}) }}"
  when: ansible_facts['pkg_mgr'] == 'apt'

# --- Optional: install pgtune from PGDG ---
# Only if your role enables pgtune.
- name: Install pgtune
  ansible.builtin.apt:
    name: pgtune
    state: present
    update_cache: true
    cache_valid_time: "{{ apt_cache_valid_time | default(3600) }}"
  environment: "{{ postgresql_env | default({}) }}"
  when:
    - ansible_facts['pkg_mgr'] == 'apt'
    - (postgresql_pgtune | default(false)) | bool
